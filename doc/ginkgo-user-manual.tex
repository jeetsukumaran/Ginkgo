\documentclass[11pt]{article}
\usepackage{geometry}                % See geometry.pdf to learn the layout options. There are lots.
\geometry{letterpaper}                   % ... or a4paper or a5paper or ...
%\geometry{landscape}                % Activate for for rotated page geometry
%\usepackage[parfill]{parskip}    % Activate to begin paragraphs with an empty line rather than an indent
\usepackage{graphicx}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{natbib}
\usepackage{epstopdf}
\usepackage{color}
\usepackage{listings}

\definecolor{xmlelem}{RGB}{0,128,128}
\definecolor{xmlattr}{RGB}{255,128,0}

\lstnewenvironment{ginkgoxml}[1][]{
\lstset{basicstyle=\scriptsize\ttfamily,
		identifierstyle=\color{black},
		commentstyle=\color{white},
		stringstyle=\ttfamily,
		showstringspaces=false,
		classoffset=0,
		morekeywords={xml, ginkgo, world, biota, samples, lineage, fitnessTraitRelativeSelectionWeights, fitnessTraitDefaultGenotypes, fitnessTraitInheritanceStdDev, fecundity, seedPopulation, seedPopulations, ancestralPopulationSize, ancestralGenerations, movementCapacity,  occurrence, environments, fitnessTraitOptima, carryingCapacity, movementCosts, movementProbabilities, dispersals, dispersal, probability, environment, sample, individualsPerCell, cellCoordinates, cellIndexes}, keywordstyle=\color{xmlelem}\bfseries,
		classoffset=1,
		morekeywords={version, label, x_range, y_range, num_gens, num_fitness_traits, global_selection_strength, random_seed, log_frequency, multifurcating_trees, final_output, full_complement_diploid_trees, default_cell_carrying_capacity, lineage, x, y, cell, gen, size, from_x, from_y, to_x, to_y, trait, distribution}, keywordstyle=\color{xmlattr},
		classoffset=0,
}
}
{}

\lstnewenvironment{shell}[1][]{
\lstset{basicstyle=\scriptsize\ttfamily,
		identifierstyle=\color{black},
		commentstyle=\color{white},
		stringstyle=\ttfamily,
		showstringspaces=false,
}
}
{}


\DeclareGraphicsRule{.tif}{png}{.png}{`convert #1 `dirname #1`/`basename #1 .tif`.png}

\newcommand{\xmlelem}[1]{{\tt<\textcolor{xmlelem}{#1}>}}
\newcommand{\xmlattr}[1]{{\tt\textcolor{xmlattr}{#1}}}

\title{Ginkgo User Manual}
\author{Jeet Sukumaran and Mark T. Holder}
\date{}                                           % Activate to display a given date or no date

\setlength{\parindent}{0in}
\setlength{\parskip}{.1in}

\begin{document}
\maketitle

\part{The Configuration File}

The Ginkgo configuration file controls almost every aspect of the simulation, from start to finish, including the final output.
The configuration file is in XML format.
A feature-complete configuration file is shown below.
Specific elements will be described and explained in subsequent sections.
\begin{ginkgoxml}
<?xml version="1.0"?>
<ginkgo>
    <world label="ginkgo_run"
           x_range = "25"
           y_range = "25"
           num_gens = "20001"
           num_fitness_traits = "5"
           global_selection_strength="1.0"
           default_cell_carrying_capacity = "100"
           random_seed = "2718281828"
           log_frequency= "10"
           multifurcating_trees = "True"
           final_output = "True"
           full_complement_diploid_trees = "False">
        <biota>
            <lineage id="Zx">
                <fitnessTraitRelativeSelectionWeights>
                	1 1 1 1 1
                </fitnessTraitRelativeSelectionWeights>
                <fitnessTraitDefaultGenotypes>
                	0 0 0 0 0
                </fitnessTraitDefaultGenotypes>
                <fitnessTraitInheritanceStdDev>
                	0.7071068 0.7071068 0.7071068 0.7071068 0.7071068
                </fitnessTraitInheritanceStdDev>
                <fecundity>20</fecundity>
                <seedPopulations>
                    <seedPopulation x="19" y="19" size="30">
                        <ancestralPopulationSize>100</ancestralPopulationSize>
                        <ancestralGenerations>1000</ancestralGenerations>
                    </seedPopulation>
                </seedPopulations>
                <movementCapacity distribution="poisson">30</movementCapacity>
            </lineage>
            <lineage id="Zy">
                <fitnessTraitRelativeSelectionWeights>
                	1 1 1 1 1
                </fitnessTraitRelativeSelectionWeights>
                <fitnessTraitDefaultGenotypes>
                	0 0 0 0 0
                </fitnessTraitDefaultGenotypes>
                <fitnessTraitInheritanceStdDev>
                	0.7071068 0.7071068 0.7071068 0.7071068 0.7071068
                </fitnessTraitInheritanceStdDev>
                <seedPopulations>
                    <seedPopulation cell="130" size="0">
                        <ancestralPopulationSize>100</ancestralPopulationSize>
                        <ancestralGenerations>1000</ancestralGenerations>
                    </seedPopulation>
                </seedPopulations>
                <movementCapacity distribution="constant">10</movementCapacity>
            </lineage>
        </biota>
        <environments>
            <environment gen="0">
                <carryingCapacity>cc.grd</carryingCapacity>
                <movementProbabilities lineage="Zx">movp_zx.grd</movementCosts>
                <movementCosts lineage="Zx">movc_zx.grd</movementCosts>
                <movementProbabilities lineage="Zy">movp_zy.grd</movementCosts>
                <movementCosts lineage="Zy">movc_zy.grd</movementCosts>
                <fitnessTraitOptima trait="0">env0.grd</fitnessTraitOptima>
            </environment>
            <environment gen="10000">
                <fitnessTraitOptima trait="0">env2.grd</fitnessTraitOptima>
            </environment>
        </environments>
        <dispersals>
            <dispersal gen="100" from_x="0" from_y="10" to_x="25" to_y="10">
                <lineage>Zx</lineage>
                <probability>1.0</probability>
            </dispersal>
            <dispersal gen="100" from_x="0" from_y="10" to_x="25" to_y="10">
                <lineage>Zy</lineage>
                <probability>1.0</probability>
            </dispersal>
            <dispersal gen="1500" from_x="0" from_y="10" to_x="25" to_y="10">
                <lineage>Zx</lineage>
                <probability>1.0</probability>
            </dispersal>
        </dispersals>
        <samples>
            <sample label="check" lineage="Zx" gen="1" />
            <sample label="check" lineage="Zy" gen="1" />
            <sample label="final" lineage="Zx" gen="10000" >
                <individualsPerCell>20</individualsPerCell>
                <cellIndexes>
                    130 131 132 133 134      140 141 142 143 144
                    155 156 157 158 159      165 166 167 168 169
                    180 181 182 183 184      190 191 192 193 194
                    205 206 207 208 209      215 216 217 218 219
                    230 231 232 233 234      240 241 242 243 244

                    380 381 382 383 384      390 391 392 393 394
                    405 406 407 408 409      415 416 417 418 419
                    430 431 432 433 434      440 441 442 443 444
                    455 456 457 458 459      465 466 467 468 469
                    480 481 482 483 484      490 491 492 493 494
                </cellIndexes>
            </sample>
            <sample label="final1" lineage="Zy" gen="10000" >
                <individualsPerCell>20</individualsPerCell>
                <cellCoordinates>
                    05,05 06,05 07,05 08,05 09,05    15,05 16,05 17,05 18,05 19,05
                    05,06 06,06 07,06 08,06 09,06    15,06 16,06 17,06 18,06 19,06
                    05,07 06,07 07,07 08,07 09,07    15,07 16,07 17,07 18,07 19,07
                    05,08 06,08 07,08 08,08 09,08    15,08 16,08 17,08 18,08 19,08
                    05,09 06,09 07,09 08,09 09,09    15,09 16,09 17,09 18,09 19,09

                    05,15 06,15 07,15 08,15 09,15    15,15 16,15 17,15 18,15 19,15
                    05,16 06,16 07,16 08,16 09,16    15,16 16,16 17,16 18,16 19,16
                    05,17 06,17 07,17 08,17 09,17    15,17 16,17 17,17 18,17 19,17
                    05,18 06,18 07,18 08,18 09,18    15,18 16,18 17,18 18,18 19,18
                    05,19 06,19 07,19 08,19 09,19    15,19 16,19 17,19 18,19 19,19
                </cellCoordinates>
            </sample>
            <sample label="final1" lineage="Zx" gen="20000" >
                <individualsPerCell>20</individualsPerCell>
                <cells>
                    10,0  14,0   10,9   14,9     30,0  34,0  30,9  34,9
                    10,20 14,20  10,29  14,29    30,20 34,20 30,9  34,29
                    10,40 14,40  10,49  14,49    30,40 34,40 30,49 34,49
                </cells>
            </sample>
            <sample label="final2" lineage="Zy" gen="20000" >
                <individualsPerCell>20</individualsPerCell>
                <cells>
                    10,0  14,0   10,9   14,9     30,0  34,0  30,9  34,9
                    10,20 14,20  10,29  14,29    30,20 34,20 30,9  34,29
                    10,40 14,40  10,49  14,49    30,40 34,40 30,49 34,49
                </cells>
            </sample>
        </samples>
    </world>
</ginkgo>
\end{ginkgoxml}



\section{The \xmlelem{world} Element}

This element is \textbf{mandatory} and only a \textbf{single} instance is allowed.
Its attributes and child elements essentially make up the core of the simulation, from initialization to main cycles to reporting and output.

\subsection{Required Attributes}
\begin{description}

	\item[\xmlattr{label}] This defines a common prefix for all output files from a run of this simulation. If the ``\verb=-i='' command-line option is passed to the Ginkgo invocation, the identifier given by the ``\verb=-i='' will be appended to the end of the string given by ``\verb=label=''.

	For example, if the following was passed to Ginkgo using the command ``\verb=ginkgo example.xml='',

	\begin{ginkgoxml}
<?xml version="1.0"?>
<ginkgo>
    <world label="ginkgo_run" ...>
	.
	.
	.
    </world>
</ginkgo>
	\end{ginkgoxml}

then all output files (logs, trees, etc.) would be prefixed by ``\verb=ginkgo_run='':

\begin{shell}
ginkgo_run.conf.log
ginkgo_run.err.log
ginkgo_run.out.log
ginkgo_run_G100_Pseudozoon.diploid1.tre
ginkgo_run_G100_Pseudozoon.haploid.tre
ginkgo_run_G100_Pseudozoon.traits.nex
ginkgo_run_G100_Pseudozoon_occurrences.grd
\end{shell}

But if invoked using the command ``\verb=ginkgo -i _r01 example.xml='', then the file names would be:

\begin{shell}
ginkgo_run_r01.conf.log
ginkgo_run_r01.err.log
ginkgo_run_r01.out.log
ginkgo_run_G100_Pseudozoon_r01.diploid1.tre
ginkgo_run_G100_Pseudozoon_r01.haploid.tre
ginkgo_run_G100_Pseudozoon_r01.traits.nex
ginkgo_run_G100_Pseudozoon_occurrences_r01.grd
\end{shell}

This combination of an optional replicate identifier in the Ginkgo invocation and simulation schema label allows you to run multiple realizations of the same simulation regime, but maintain distinct sets of output files for each realization in the same directory.

	\item[\xmlattr{x\_range}] This requires a \textbf{positive non-zero integer} argument, and defines the landscape dimension in terms of numbers of columns.

	\item[\xmlattr{y\_range}] This requires a \textbf{positive non-zero integer} argument, and defines the landscape dimension in terms of numbers of rows.

	\item[\xmlattr{num\_gens}] This requires a \textbf{positive non-zero integer} argument, and defines the number of generations of cycles that the simulation will run.

\end{description}

\subsection{Optional Attributes}
\begin{description}
	\item[\xmlattr{num\_fitness\_traits}] This requires a \textbf{positive non-zero integer} argument, and defines the number of fitness factors in the simulation. If not specified, defaults to 10.
	\item[\xmlattr{global\_selection\_strength}] This requires a \textbf{positive real number} argument, and weights the overall multi-dimensional Euclidean distance between the vector of an organism's traits and the corresponding environmental optima. A value of 0.0 means that \textbf{no} selection takes place. A value of 1.0 results in the survival probability of the organisms given directly by the exponentiated distance, while higher values increase the strength of selection by lowering the survival probability of an organism for a given trait-optima distance. If not specified, defaults to 1.
	\item[\xmlattr{default\_cell\_carrying\_capacity}] The standard way of specifying cell carrying capacities is to provide an ESRI ASCII grid file. However, in some contexts, this may be overkill, and it is simpler to just define the same, fixed, carrying capacity for each of the cells in the landscape. The ``\verb=default_cell_carrying_capacity='' serves this purpose, and takes a \textbf{positive non-zero integer argument} that defines the carrying capacity of each cell in the landscape until over-ridden by an ESRI ASCII grid file at some point in the simulation. If not specified, defaults to 0.
	\item[\xmlattr{random\_seed}] Seed for pseudo-random number generator. Command-line specified seed (using the ``{\tt -z}'' flag) overrides this, and if neither are specified, then defaults to system time.
	\item[\xmlattr{log\_frequency}] Non-zero positive integer specifying frequency of log output in terms of numbers of generations. Defaults to 10.
	\item[\xmlattr{multifurcating\_trees}] If ``True'', then multifurcating trees are preserved. If ``False'', then multifurcating trees are converted into bifurcating trees by arbitrarily resolving the polytomies with new edges of length 0. Defaults to ``True'' (i.e., preserve polytomies).
	\item[\xmlattr{final\_output}] By default, at the end of the simulation Ginkgo samples and reports the genealogies, traits and occurrences of \textit{every} organism of \textit{every} lineage in \textit{every} cell.  Setting \xmlattr{final\_output} to ``False'' suppresses the automatic reporting of the full results. For large simulations, you may prefer to restrict the output to your own custom fine-tuned sampling regime.
	\item[\xmlattr{full\_complement\_diploid\_trees}]	By default, the genealogies for the diploid locii are built by randomly sampling one of the alleles of the diploid complement for each organism (and saved with the ``{\tt .diploid1.tre}'' extension). By setting this attribute to ``True'', you can ask that Ginkgo produce a file (which will be saved with the ``{\tt .diploid2.tre}''  extension) where \textit{both} alleles are sampled.
\end{description}

The \xmlelem{world} element has the following child elements: \xmlelem{biota}, \xmlelem{environments}, \xmlelem{dispersals}, and \xmlelem{samples}.


\section{The \xmlelem{biota} Element}

This element is \textbf{mandatory} and only a \textbf{single} instance is allowed.
Its attributes and child elements defines the ecological and evolutionary aspects of the organisms that are the primary agents of the simulation.

\subsection{The \xmlelem{lineage} Element}
This element defines a single lineage in the simulation. It has one mandatory attribute, \xmlattr{id}, which provides a reference label for the lineage, and which will be suffixed to the output files for the tree and character samples of this lineage.


\subsubsection{The \xmlelem{fitnessTraitRelativeSelectionWeights} Element}

An environment niche is defined for each lineage through the \xmlelem{fitnessTraitRelativeSelectionWeights} element.
The contents of this element should be a space-delimited list of numeric values that provide the \textit{relative} weights of the selection pressures for each of traits in the fitness function
For example, ``1 1 1 1 1'' models a niche in which the organism is equally sensitive to all 5 environmental dimensions, while ``5 1 1 1 0'' models a nich in which the organism is extremely sensitive to the first environmental dimension, and, conversely extremely insensitive to the last environmental dimension, while having a moderate sensitivity to the remaining middle three dimensions.
As these are relative weights, then ``1 1 1 1 1'' and ``2 2 2 2 2'' etc., all describe the same niche.
If not provided, then this vector defaults to equal-weighting on all environment distances (i.e., equivalent to ``$1 \ 1 \ 1 \ \dots \ q$''), where $q$ is the number of traits or dimensions in the simulation.

\subsubsection{The \xmlelem{fitnessTraitDefaultGenotypes} Element}

The traits of organisms evolve under the specified selection pressures once the simulation begins, but the initial values for the traits for the first generation of organisms of each lineage are specified by the \xmlelem{fitnessTraitDefaultGenotypes} element, the contents of which should be a space-delimited list of numeric values.
If not given, this defaults to ``$0 \ 0 \ 0 \ \dots \ q$'', where $q$ is the number of traits or dimensions in the simulation.

\subsubsection{The \xmlelem{fitnessTraitInheritanceStdDev} Element}

The trait value of each offspring is given by the mean of the corresponding trait of each of its parents, plus a normally-distributed error with mean 0 and a standard deviation given by the \xmlelem{fitnessTraitInheritanceStdDev} element.
If not specified this defaults to 0.7071068 for each trait (i.e., $\sqrt{\frac{1}{2}}$).
Values lower than this means that the variation in the trait value tends to reduce over time, while values lower than this means that the variation in the trait value tends to increase over time.

\subsubsection{The \xmlelem{seedPopulations} Element}

In the first generation of the simulation, ``seed'' populations are introduced into the landscape.
These ``seed'' populations are collections of individuals sampled from a larger population that has been ``bootstrapped'' under a pure Wright-Fisher demographic model for a pre-specified number of generations.
For example, you may wish to introduce 100 individuals into a cell at $(0,0$), drawn from an ancestral population of 1000 organisms that has been evolving under a pure coalescence model for 10000 generations, in which case you would specify:

\begin{ginkgoxml}
<seedPopulation x="0" y="0" size="100">
	<ancestralPopulationSize>1000</ancestralPopulationSize>
	<ancestralGenerations>10000</ancestralGenerations>
</seedPopulation>
\end{ginkgoxml}

The \xmlattr{x} and \xmlattr{y} attributes specify the X- and Y-coordinate of the cell on the landscape to populate, while the \xmlattr{size} attribute specifies the size of the seed population.
The \xmlelem{ancestralPopulationSize} element specifies the ancestral population size, while the \xmlelem{ancestralGenerations} element specifies the number of generations that the ancestral population has been evolving under a Wright-Fisher model.

\subsubsection{The \xmlelem{movementCapacity} Element}
This element defines the potential movement of organisms of this lineage in the ``local'' movement framework. It can be a constant value (i.e., every organism gets the same value), specified by setting the attribute \xmlattr{distributed} to ``constant'' and the contents of the element to the value, or a Poisson-distributed value, specified by setting the attribute \xmlattr{distributed} to ``poisson'' and the contents of the element to the mean of the distribution.

\section{The \xmlelem{environments} Element}

The \xmlelem{environments} element collects the abiotic settings of the simulation, organized into distinct \xmlelem{environment} child elements, each of which is keyed to a particular generation at which it comes into effect.

\subsection{The \xmlelem{environment} Element}
The \xmlelem{environment} element has a single attribute, \xmlattr{gen}, which takes a positive integer value as an argument, specifying the 0-based index of the simulation cycle or generation in which the landscape configuration, settings or parameters set by it come into affect.

Three classes of child elements are available to configure the landscape settings for a particular generation.

\subsection{The \xmlelem{carryingCapacity} Element}

The \xmlelem{carryingCapacity} element determines the maximum number of organisms that can occupy each cell on the landscape. It requires a path to an ESRI AsciiGrid format file of the same dimensions of the landscape, with the grid values being positive integers specifying the carrying capacity of the corresponding cell. If not given for a particular generation, then the previous setting is retained.


\subsection{The \xmlelem{movementProbabilities} Element}

The \xmlelem{movementProbabilities} element determines the per-lineage per-cell probability that an organism occupying a particular cell will move. It has one attribute, \xmlattr{lineage}, which specifies the lineage (by identifier) to which the probabilities apply, and its content should be the path to an ESRI AsciiGrid format file of the same dimensions of the landscape, with the grid values being real values specifying the probability of movement for an organism in each cell.

\subsection{The \xmlelem{movementCosts} Element}

The \xmlelem{movementCosts} element determines the ``entry costs'' per cell for a particular lineage. It has one attribute, \xmlattr{lineage}, which specifies the lineage (by identifier) to which the costs apply, and its content should be the path to an ESRI AsciiGrid format file of the same dimensions of the landscape, with the grid values being positive integers specifying the entry costs for each cell. Note that the movement costs only get used if an organism attempts to move, i.e., the probability of movement (see the ``\xmlelem{movementProbabilities}'' element, above) must be sufficient so as movement to be initiated.


\subsection{The \xmlelem{fitnessTraitOptima} Element}

The \xmlelem{fitnessTraitOptima} element sets the optimum value for a particular fitness trait. It has one attribute, \xmlattr{trait}, which should be a positive integer specifying the 0-based index of the particular trait, and its content should be an ESRI AsciiGrid format file of the same dimensions of the landscape, with the grid values being real values specifying the environmental optimum for the trait given by \xmlattr{trait} for a particular cell.

\section{The \xmlelem{samples} Element}

The \xmlelem{samples} element describes the sampling regime of the simulation as a collection of distinct \xmlelem{sample} elements.

Each \xmlelem{sample} element has three attributes: \xmlattr{gen} specifies the 0-based index of the simulation generatio that the sample is to be taken, \xmlattr{lineage} specifies the lineage of the organisms to be sampled, while \xmlattr{label} provides a suffix to be appended to the end of the files generated by this sampling.
Note that if you specify multiple samples of the \textit{same} lineage during the \textit{same} generation (perhaps sampling different cells), explicit specification of different \xmlattr{label} identifiers is required to avoid the output files of the second sample overwriting those of the first.

Each sampling results in at least 3 files:
\begin{enumerate}
	\item A genealogy of the haploid loci of the sampled organisms.
	\item The genealogies of the diploid loci of the sampled organisms, with one allele picked at random from the diploid complement at each locus of each sampled organism.
	\item A character data matrix summarizing the fitness trait values of the sampled organisms, as well as the overall fitness of the organism in its residence cell.
	\item A grid summarizing the occurrence of organisms of the specified lineage in each cell (i.e., the number of organisms in each cell of the specified lineage).
\end{enumerate}

By default, a sample directive results in every organism of the specified lineage in every cell being sampled.
This behavior can be modified by the \xmlelem{individualsPerCell} element, which specifies the maximum number of organisms to be (randomly) sampled from each cell, or the \xmlelem{cells} element, which specifies a subset of cells to be sampled.
The \xmlelem{cells} element requires a space-delimited list of $X,Y$ coordinates of the cells to be sampled, which each coordinate being separated by a comma. Note that the coordinates are 0-based, with the upper-left corner cell having a coordinate of $(0,0)$.




\end{document}
